---
title: "Clase desmostrativa: Prueba de Mantel"
author: "David Murillo"
format: html
editor: visual
---

[<img src="HN Cursos publicidad/HN Biology Inv Circle.jpg" align="right" width="100"/>](https://www.hnbiology.org/)

Esta es una clase demostrativa en la que exploraremos el uso de la prueba de Mantel en ecología. Durante la sesión, explicaremos qué es la prueba de Mantel, cómo y para qué se utiliza, y proporcionaremos una guía práctica sobre cómo realizarla e interpretarla utilizando R.

**Descripción de la prueba de Mantel basada en McCune y Grace (2002)**

La prueba de Mantel se utiliza para probar la hipótesis nula de que no existe relación entre dos matrices cuadradas simétricas. Esta prueba evalúa la correlación entre matrices de distancia (o de similitud). Generalmente, cada matriz se calcula a partir de diferentes conjuntos de variables, medidos en la misma unidad de muestreo.

La prueba de Mantel es una alternativa a la regresión de una matriz contra otra, evitando el problema de dependencia parcial dentro de cada matriz. Debido a que las celdas en las matrices no son independientes entre sí, no podemos aceptar el valor de *P* derivado de técnicas estándar que asumen independencia de las observaciones. Sin embargo, la correlación (*r*) puede utilizarse como una medida de la fuerza de la relación entre las matrices; en este contexto, *r* se denomina **estadística estandarizada de Mantel**, y los valores de *r* oscilan entre -1 y 1.

**Cuándo utilizar la prueba de Mantel**

La prueba de Mantel se utiliza para evaluar la congruencia entre dos matrices de distancias (o similitudes) de las mismas dimensiones. Ambas matrices deben referirse al mismo conjunto de entradas en el mismo orden. Por ejemplo, es útil cuando queremos evaluar la correspondencia entre:

1)  Dos grupos de organismos en el mismo conjunto de unidades de muestreo (plantas e invertebrados).

2)  Matrices de disimilitud que representan la estructura de comunidades antes y después de una perturbación.

3)  Distancia geográfica y distancia ecológica.

4)  Distancia genética y distancia geográfica.

**Qué reportar**

1)  Contenido y tamaño de las dos matrices.

2)  Método de evaluación de la prueba estadística (aproximación asintótica de Mantel o randomización).

3)  Estadística estandarizada de Mantel *r*.

4)  Valor *P*.


## Ejecicio de la clase

::: panel-tabset 

### Cargar paquetes

```{r, message=FALSE, warning=FALSE}
library(tidyverse)
library(readxl)
library(ecodist)
library(vegan)
library(geosphere)
```


### Ingreso de base de datos

```{r, echo=FALSE, message=FALSE, warning=FALSE}
BirdData <- read_excel("Data/Data_birds.xls", sheet = 1)
BirdData2 <- read_excel("Data/Data_birds.xls", sheet = 2)
BirdData3 <- read_excel("Data/Data_birds.xls", sheet = 3)


BirdData <- BirdData %>% 
  select(`Sitio nombre`, `Sitio #`, Especies) %>% 
  mutate(Visita = "Uno")

BirdData2 <- BirdData2 %>% 
  select(`Sitio nombre`, `Sitio #...2`  , Especies) %>% 
  mutate(Visita = "Dos")

BirdData3 <- BirdData3 %>% 
  select(`Sitio nombre`, `Sitio #...2`  , Especies) %>% 
  mutate(Visita = "Tres")



colnames(BirdData) <-c( "SitioNombre", "SitioCod", "Especies", "Visita")
colnames(BirdData2) <-c( "SitioNombre", "SitioCod", "Especies", "Visita")
colnames(BirdData3) <-c( "SitioNombre", "SitioCod", "Especies", "Visita")

BirdFull <- rbind(BirdData, BirdData2, BirdData3)


BirdWider <- BirdFull %>% 
  group_by(SitioNombre, SitioCod, Especies) %>% 
  summarise(Abundance = max(n())) %>% 
  pivot_wider(names_from = Especies, values_from = Abundance,
              values_fill = 0) %>% 
  separate(SitioCod, into = c("Sitio", "Sistema"), sep = "(?<=[0-9])(?=[A-Za-z])" )

Sitios <- read_excel("Data/Data_birds.xls", sheet = "PTS")

# Unir base de datos

DataBirdLoc <- Sitios %>% 
  mutate(ID = as.character(ID)) %>% 
  rename("Sitio" = ID,
         "SitioNombre" = SiteName) %>% 
  full_join(BirdWider, by = c("Sitio", "SitioNombre"))

rownames(DataBirdLoc) <- DataBirdLoc$Sitio

DataBirdLoc <- DataBirdLoc %>% 
  na.omit()

saveRDS(DataBirdLoc, "Data/DatosMantel.rds")
```

```{r}
DataBirdLoc <- readRDS("Data/DatosMantel.rds")
```


### Estimacion de distancias distancias geograficas y ecologicas

#### Estimar distancia geografica entre los sitios de estudio

```{r}

coords <- as.matrix(DataBirdLoc[, c("LONG", "LAT")])

distance_matrix <- distm(coords, fun = distHaversine)
distance_matrix_km <- distance_matrix / 1000

colnames(distance_matrix_km) <- DataBirdLoc$Sitio
```

#### Estimar distancia ecologica entre los sitios de estudio

```{r}
bird_bc <- as.matrix(distance(DataBirdLoc[,15:150], "bray-curtis"))

dim(bird_bc)           
dim(distance_matrix_km)

```


### Prueba de Mantel

```{r}
vegan::mantel(bird_bc, distance_matrix_km, method = "spearman")
```


### Graficos relevantes


:::



![HN Biology Investigation Academy](HN%20Cursos%20publicidad/HN%20Biology%20Inv%20large.jpg)
